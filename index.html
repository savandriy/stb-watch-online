<head>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
</head>


<script>
  const CORS_SERVER = "https://cors-anywhere.herokuapp.com"; 
  const STARLIGHT_API_HOST = "https://vcms-api2.starlight.digital/player-api/";
  const STARLIGHT_PLAYER_STRING = "https://player.starlight.digital/vplayer/?hash=";
  
  async function makeRequest (url, response_type) {
    let response = await fetch(`${CORS_SERVER}/${url}`);
    if (response.ok) { // if HTTP status 200-299
      if (response_type === "text") {
        return await response.text();
      } else if (resposne_type === "json") {
        return await response.json();
      } 
    } else {
      throw new Error('Request failed!');
    }
  }
  
  function createVideo (url) {
    // remove previous video, if exists
    let oldVideoNode = document.querySelector('video');
    if (typeof(oldVideoNode) != 'undefined' && oldVideoNode != null)
    {
      oldVideoNode.remove();   
    }
    
    // create video
    let videoNode = document.createElement("VIDEO");

    videoNode.setAttribute("src", url);
    videoNode.setAttribute("width", "640");
    videoNode.setAttribute("height", "480");
    videoNode.setAttribute("controls", "controls");
    
    document.getElementById("video").appendChild(videoNode);
  }
  
  async function main () {
    try {
      // get url from input
      let stbUrl = document.getElementById("url-input").value;
      
      // get html from stb
      let stbHTML = await makeRequest(stbUrl, "text");

      // scrape the html
      let parser = new DOMParser();
      let stbDoc = parser.parseFromString(stbHTML, 'text/html');
      let starlightPlayerUrl = stbDoc.querySelector('meta[itemprop="embedURL"]').content;
      let starlightApiUrl = starlightPlayerUrl.replace(STARLIGHT_PLAYER_STRING, STARLIGHT_API_HOST).replace("&", "?");

      // get the video file url
      let starlightJson = await makeRequest(starlightApiUrl, "json");
      let videoFileUrl = starlightJson.video[0].media.pop().url;

      // create video
      createVideo(videoFileUrl);
      
    } catch (e) {
      alert(e)
    } 
  }
</script>

<div class="container">
  <h1>STB Watch online</h1>
  
  <label for="url-input">Please input a URL like https://holostyak.stb.ua/ru/episode/holostyak-10-sezon-vypusk-1-chast-2-ot-06-03-2020/</label>
  <div class="input-group">
    <input id="url-input" type="text" class="form-control" placeholder="STB video page url">
    <div class="input-group-append">
      <button class="btn btn-primary" type="button" onclick="main()">Watch</button>
    </div>
  </div>
  
  <div class="text-center" id="video">
  </div>
</div>

<script>
  // set event listener to submit on Enter
  const input = document.getElementById("url-input");
  input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
          main();
      }
  });
</script>
